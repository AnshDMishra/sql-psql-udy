# PostgreSQL: How to backup and restore Database

In the previous lessons, we learned how to backup and restore a database. Before restoring a database, you need to terminate all connections to that database and prepare the backup file. In PostgreSQL, you can restore a database in two ways:

- Using `psql` to restore plain SQL script file generated by  `pg_dump` and  `pg_dumpall` tools. We illustrated how to execute an external file script in the previous lessons. However, the SQL script sometimes need to be edited or make different script to backup only the schema or data.
- Using  **pg_restore** to restore `tar` file and `directory` format created by the  `pg_dump` tool. The archive files allow `pg_restore` to **be selective about what is restored**, so you don't need to create different backups for schema, data, tables, etc.

## How to restore databases using pg_restore

Besides `psql` tool, you can use  **pg_restore** program to restore databases backed up by the  `pg_dump` or `pg_dumpall` tools.

**pg_restore** is a utility for restoring a PostgreSQL database from an **archive** created by `pg_dump` in one of the non-plain-text formats. It will issue the commands necessary to reconstruct the database to the state it was in at the time it was saved. The archive files also allow `pg_restore` to **be selective about what is restored**, or even to reorder the items prior to being restored. The archive files are designed to be portable across architectures.

**pg_restore** can operate in two modes.

- If a database name is specified, `pg_restore` connects to that database and restores archive contents directly into the database.
- Otherwise, a script containing the SQL commands necessary to rebuild the database is created and written to a file or standard output. This script output is equivalent to the plain text output format of `pg_dump`. Some of the options controlling the output are therefore analogous to `pg_dump` options.

Obviously, pg_restore cannot restore information that is not present in the archive file. For instance, if the archive was made using the “dump data as INSERT commands” option, `pg_restore` will not be able to load the data using COPY statements.

The basic syntax to restore a database with `pg_restore` for an **existing** database is shown below:

- `pg_restore` -U username **[option]** `-d` **[db_name]** **[db_backup]**

For a full list of options please type in the command line `pg_dump --help`.

A brief explanation of each **[option]** is shown below:

- `-v`: verbose mode, messages during the processing and execution of the command.
- `-O`: skip restoration of object ownership
- `-c`: clean (drop) database object before recreating
- `--if-exists`: use `IF EXISTS` when dropping objects
- `-e`: exits on error, default is to continue

- `-d`: connect to **[db_name]** (db_name is the name of the database to connect to)
- **[db_backup]**: the file generated by the `pg_dump` tool. In the case of a tar file is something like `/../my_backup.tar`. You must specify the absolute path to the backup file.

If your **database does not exists**, you can restore it using the `-C` option:

- `pg_restore` -U username **[option]** **-C** `-d` **[db_name]** **[db_backup]**

The options are now more limited:

- `-v`: verbose mode
- `-O`: skip restoration of object ownership
- `-e`: exits on error, default is to continue

The following option is mandatory in this case:

- **-C**: **create the target database**

If you want to restore only the schema or data, the options are:

- **-s**: restore only the schema, no data.
- **-a**: restore only the data, no schema.

## uniy pg_restore

Let's make a backup of the `uniy` sample database using the `pg_dump` tool.

```console
(base) ludo /~  $  pg_dump -U usertest -F t -O --no-tablespaces -c --if-exists --column-inserts uniy > /Users/ludovicopinzari/pgbackup/uniy_db_backup.tar
(base) ludo /~  $  ls pgbackup/uniy_db_backup.tar
pgbackup/uniy_db_backup.tar
```

Now, let's restore the `uniy` sample database using the `pg_restore` command.

- `pg_restore` -U usertest **-v** **-O** **-c** **--if-exists** **-e** `-d uniy` `/Users/ludovicopinzari/pgbackup/uniy_db_backup.tar`

Let's execute the command in the command line.

```console
(base) ludo /Sql_udacity  $  pg_restore -U usertest -v -O -c --if-exists -e -d uniy /Users/ludovicopinzari/pgbackup/uniy_db_backup.tar
pg_restore: connecting to database for restore
pg_restore: dropping FK CONSTRAINT sections sections_fkey_teacher
pg_restore: dropping FK CONSTRAINT sections sections_fkey_course
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_student
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_section
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_course
pg_restore: dropping CONSTRAINT teachers teachers_pkey
pg_restore: dropping CONSTRAINT students students_pkey
pg_restore: dropping CONSTRAINT sections sections_pkey
pg_restore: dropping CONSTRAINT enrolls enrolls_pkey
pg_restore: dropping CONSTRAINT courses courses_pkey
pg_restore: dropping TABLE DATA teachers
pg_restore: dropping TABLE DATA students
pg_restore: dropping TABLE DATA sections
pg_restore: dropping TABLE DATA enrolls
pg_restore: dropping TABLE DATA courses
pg_restore: dropping TABLE teachers
pg_restore: dropping TABLE students
pg_restore: dropping TABLE sections
pg_restore: dropping TABLE enrolls
pg_restore: dropping TABLE courses
pg_restore: creating TABLE "public.courses"
pg_restore: creating TABLE "public.enrolls"
pg_restore: creating TABLE "public.sections"
pg_restore: creating TABLE "public.students"
pg_restore: creating TABLE "public.teachers"
pg_restore: processing data for table "public.courses"
pg_restore: processing data for table "public.enrolls"
pg_restore: processing data for table "public.sections"
pg_restore: processing data for table "public.students"
pg_restore: processing data for table "public.teachers"
pg_restore: creating CONSTRAINT "public.courses courses_pkey"
pg_restore: creating CONSTRAINT "public.enrolls enrolls_pkey"
pg_restore: creating CONSTRAINT "public.sections sections_pkey"
pg_restore: creating CONSTRAINT "public.students students_pkey"
pg_restore: creating CONSTRAINT "public.teachers teachers_pkey"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_course"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_section"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_student"
pg_restore: creating FK CONSTRAINT "public.sections sections_fkey_course"
pg_restore: creating FK CONSTRAINT "public.sections sections_fkey_teacher"
```

Let's connect to the `uniy` sample database and list the tables and records.

1. **login in the uniy database**


```console
(base) ludo /~  $  psql uniy -U usertest
psql (11.4)
Type "help" for help.

uniy=>
```

2. **List the tables**

```console
uniy=> \dt
          List of relations
 Schema |   Name   | Type  |  Owner
--------+----------+-------+----------
 public | courses  | table | usertest
 public | enrolls  | table | usertest
 public | sections | table | usertest
 public | students | table | usertest
 public | teachers | table | usertest
(5 rows)
```

3. **Describe tables**

**students**

```console
uniy=> \d students
                    Table "public.students"
    Column    |     Type      | Collation | Nullable | Default
--------------+---------------+-----------+----------+---------
 student_id   | smallint      |           | not null |
 student_name | character(18) |           |          |
 address      | character(20) |           |          |
 city         | character(10) |           |          |
 state        | character(2)  |           |          |
 zip          | character(5)  |           |          |
 gender       | character(1)  |           |          |
Indexes:
    "students_pkey" PRIMARY KEY, btree (student_id)
Referenced by:
    TABLE "enrolls" CONSTRAINT "enrolls_fkey_student" FOREIGN KEY (student_id) REFERENCES students(student_id) ON DELETE CASCADE
```

**courses**
```console
uniy=> \d courses
                    Table "public.courses"
   Column    |     Type      | Collation | Nullable | Default
-------------+---------------+-----------+----------+---------
 course_id   | smallint      |           | not null |
 course_name | character(20) |           |          |
 department  | character(16) |           |          |
 num_credits | smallint      |           |          |
Indexes:
    "courses_pkey" PRIMARY KEY, btree (course_id)
Referenced by:
    TABLE "enrolls" CONSTRAINT "enrolls_fkey_course" FOREIGN KEY (course_id) REFERENCES courses(course_id) ON DELETE CASCADE
    TABLE "sections" CONSTRAINT "sections_fkey_course" FOREIGN KEY (course_id) REFERENCES courses(course_id) ON DELETE CASCADE
```

**teachers**

```console
uniy=> \d teachers
                    Table "public.teachers"
    Column    |     Type      | Collation | Nullable | Default
--------------+---------------+-----------+----------+---------
 teacher_id   | smallint      |           | not null |
 teacher_name | character(18) |           |          |
 phone        | character(10) |           |          |
 salary       | numeric(10,2) |           |          |
Indexes:
    "teachers_pkey" PRIMARY KEY, btree (teacher_id)
Referenced by:
    TABLE "sections" CONSTRAINT "sections_fkey_teacher" FOREIGN KEY (teacher_id) REFERENCES teachers(teacher_id) ON DELETE SET NULL
```

**sections**

```console
uniy=> \d sections
                 Table "public.sections"
    Column    |   Type   | Collation | Nullable | Default
--------------+----------+-----------+----------+---------
 course_id    | smallint |           | not null |
 section_id   | smallint |           | not null |
 teacher_id   | smallint |           |          |
 num_students | smallint |           |          |
Indexes:
    "sections_pkey" PRIMARY KEY, btree (course_id, section_id)
Foreign-key constraints:
    "sections_fkey_course" FOREIGN KEY (course_id) REFERENCES courses(course_id) ON DELETE CASCADE
    "sections_fkey_teacher" FOREIGN KEY (teacher_id) REFERENCES teachers(teacher_id) ON DELETE SET NULL
Referenced by:
    TABLE "enrolls" CONSTRAINT "enrolls_fkey_section" FOREIGN KEY (course_id, section_id) REFERENCES sections(course_id, section_id) ON DELETE CASCADE
```

**enrolls**

```console
uniy=> \d enrolls
                 Table "public.enrolls"
   Column   |   Type   | Collation | Nullable | Default
------------+----------+-----------+----------+---------
 course_id  | smallint |           | not null |
 section_id | smallint |           | not null |
 student_id | smallint |           | not null |
 grade      | smallint |           |          |
Indexes:
    "enrolls_pkey" PRIMARY KEY, btree (course_id, section_id, student_id)
Foreign-key constraints:
    "enrolls_fkey_course" FOREIGN KEY (course_id) REFERENCES courses(course_id) ON DELETE CASCADE
    "enrolls_fkey_section" FOREIGN KEY (course_id, section_id) REFERENCES sections(course_id, section_id) ON DELETE CASCADE
    "enrolls_fkey_student" FOREIGN KEY (student_id) REFERENCES students(student_id) ON DELETE CASCADE
```

4. **Describe tables records**

**students**

```console
uniy=> SELECT * FROM students;
 student_id |    student_name    |       address        |    city    | state |  zip  | gender
------------+--------------------+----------------------+------------+-------+-------+--------
        148 | Susan Powell       | 534 East River Dr.   | Haverford  | PA    | 19041 | F
        210 | Bob Dawson         | 120 South Jefferson  | Newport    | RI    | 02891 | M
        298 | Howard Mansfield   | 290 Wynkoop Drive    | Vienna     | VA    | 22180 | M
        348 | Susan Pugh         | 534 East Hampton Dr. | Hartford   | CT    | 06107 | F
        349 | Joe Adams          | 473 Emmerson Street  | Newark     | DE    | 19702 | M
        354 | Janet Ladd         | 441 10th Street      | Pennsburg  | PA    | 18073 | F
        410 | Bill Jones         | 120 South Harrison   | Newport    | CA    | 92660 | M
        473 | Carol Dean         | 983 Park Avenue      | Boston     | MA    | 02169 | F
        548 | Allen Thomas       | 238 West Ox Road     | Chicago    | IL    | 60624 | M
        558 | Val Shipp          | 238 Westport Road    | Chicago    | IL    | 60556 | F
        649 | John Anderson      | 473 Emmory Street    | New York   | NY    | 10008 | M
        654 | Janet Thomas       | 441 6th Street       | Erie       | PA    | 16510 | F
(12 rows)
```

**courses**

```console
uniy=> SELECT * FROM courses;
 course_id |     course_name      |    department    | num_credits
-----------+----------------------+------------------+-------------
       450 | Western Civilization | History          |           3
       730 | Calculus IV          | Math             |           4
       290 | English Composition  | English          |           3
       480 | Compiler Writing     | Computer Science |           3
       550 | Art History          | History          |           3
(5 rows)
```

**teachers**

```console
uniy=> SELECT * FROM teachers;
 teacher_id |    teacher_name    |   phone    |  salary
------------+--------------------+------------+----------
        303 | Dr. Horn           | 257-3049   | 27540.00
        290 | Dr. Lowe           | 257-2390   | 31450.00
        430 | Dr. Engle          | 256-4621   | 38200.00
        180 | Dr. Cooke          | 257-8088   | 29560.00
        560 | Dr. Olsen          | 257-8086   | 31778.00
        784 | Dr. Scango         | 257-3046   | 32098.00
        213 | Dr. Wright         | 257-3393   | 35000.00
(7 rows)
```

**sections**

```console
uniy=> SELECT * FROM sections;
 course_id | section_id | teacher_id | num_students
-----------+------------+------------+--------------
       450 |          1 |        303 |            2
       730 |          1 |        290 |            6
       290 |          1 |        430 |            3
       480 |          1 |        180 |            3
       450 |          2 |        560 |            2
       480 |          2 |        784 |            2
(6 rows)
```

**enrolls**

```console
uniy=> SELECT * FROM enrolls;
 course_id | section_id | student_id | grade
-----------+------------+------------+-------
       730 |          1 |        148 |     3
       450 |          2 |        210 |     3
       730 |          1 |        210 |     1
       290 |          1 |        298 |     3
       480 |          2 |        298 |     3
       730 |          1 |        348 |     2
       290 |          1 |        349 |     4
       480 |          1 |        410 |     2
       450 |          1 |        473 |     2
       730 |          1 |        473 |     3
       480 |          2 |        473 |     0
       290 |          1 |        548 |     2
       730 |          1 |        558 |     3
       730 |          1 |        649 |     4
       480 |          1 |        649 |     4
       450 |          1 |        654 |     4
       450 |          2 |        548 |
(17 rows)
```

### pg_restore: uniy database only schema

If we want to restore only the uniy database `schema`, the command is:

- `pg_restore` -U usertest `-v` `-O` `-c` `--if-exists` **-s** `-e` `-d uniy` `/Users/ludovicopinzari/pgbackup/uniy_db_backup.tar`

Let's execute the command in the command line.


```console
(base) ludo /~  $  pg_restore -U usertest -v -O -c --if-exists -s -e -d uniy /Users/ludovicopinzari/pgbackup/uniy_db_backup.tar
pg_restore: connecting to database for restore
pg_restore: dropping FK CONSTRAINT sections sections_fkey_teacher
pg_restore: dropping FK CONSTRAINT sections sections_fkey_course
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_student
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_section
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_course
pg_restore: dropping CONSTRAINT teachers teachers_pkey
pg_restore: dropping CONSTRAINT students students_pkey
pg_restore: dropping CONSTRAINT sections sections_pkey
pg_restore: dropping CONSTRAINT enrolls enrolls_pkey
pg_restore: dropping CONSTRAINT courses courses_pkey
pg_restore: dropping TABLE teachers
pg_restore: dropping TABLE students
pg_restore: dropping TABLE sections
pg_restore: dropping TABLE enrolls
pg_restore: dropping TABLE courses
pg_restore: creating TABLE "public.courses"
pg_restore: creating TABLE "public.enrolls"
pg_restore: creating TABLE "public.sections"
pg_restore: creating TABLE "public.students"
pg_restore: creating TABLE "public.teachers"
pg_restore: creating CONSTRAINT "public.courses courses_pkey"
pg_restore: creating CONSTRAINT "public.enrolls enrolls_pkey"
pg_restore: creating CONSTRAINT "public.sections sections_pkey"
pg_restore: creating CONSTRAINT "public.students students_pkey"
pg_restore: creating CONSTRAINT "public.teachers teachers_pkey"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_course"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_section"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_student"
pg_restore: creating FK CONSTRAINT "public.sections sections_fkey_course"
pg_restore: creating FK CONSTRAINT "public.sections sections_fkey_teacher"
```

Let's connect to the `uniy` sample database and list the tables and records.

1. **login in the uniy database**


```console
(base) ludo /~  $  psql uniy -U usertest
psql (11.4)
Type "help" for help.

uniy=>
```

2. **List the tables**

```console
uniy=> \dt
          List of relations
 Schema |   Name   | Type  |  Owner
--------+----------+-------+----------
 public | courses  | table | usertest
 public | enrolls  | table | usertest
 public | sections | table | usertest
 public | students | table | usertest
 public | teachers | table | usertest
(5 rows)
```

3. **Describe tables**

**students**

```console
uniy=> \d students
                    Table "public.students"
    Column    |     Type      | Collation | Nullable | Default
--------------+---------------+-----------+----------+---------
 student_id   | smallint      |           | not null |
 student_name | character(18) |           |          |
 address      | character(20) |           |          |
 city         | character(10) |           |          |
 state        | character(2)  |           |          |
 zip          | character(5)  |           |          |
 gender       | character(1)  |           |          |
Indexes:
    "students_pkey" PRIMARY KEY, btree (student_id)
Referenced by:
    TABLE "enrolls" CONSTRAINT "enrolls_fkey_student" FOREIGN KEY (student_id) REFERENCES students(student_id) ON DELETE CASCADE
```

4. **Describe tables records**

**students**

```console
uniy=> SELECT * FROM students;
 student_id | student_name | address | city | state | zip | gender
------------+--------------+---------+------+-------+-----+--------
(0 rows)
```

As we can see, there are no records in the tables since the `pg_restore` command imported only `uniy` schema into the database. in the next section, we are going to restore the records of the `uniy` sample database.


### pg_restore: uniy database only data

At the beginning of this lesson, we mentioned that all the records of a database could be restored using the `-a` option in the `pg_restore` command. However, if we run the command in the terminal:

```console
(base) ludo /pgbackup  $  pg_restore -U usertest -v -O -a -e -d uniy /Users/ludovicopinzari/pgbackup/uniy_db_backup.tar
pg_restore: connecting to database for restore
pg_restore: processing data for table "public.courses"
pg_restore: processing data for table "public.enrolls"
pg_restore: [archiver (db)] Error while PROCESSING TOC:
pg_restore: [archiver (db)] Error from TOC entry 3188; 0 26147 TABLE DATA enrolls usertest
pg_restore: [archiver (db)] could not execute query: ERROR:  insert or update on table "enrolls" violates foreign key constraint "enrolls_fkey_section"
DETAIL:  Key (course_id, section_id)=(730, 1) is not present in table "sections".
    Command was: INSERT INTO public.enrolls (course_id, section_id, student_id, grade) VALUES (730, 1, 148, 3);
```

We got an error.. **I'm still looking for the bug**. Maybe the TOC file processes the tables in the wrong order. In fact the `enrolls` table must be processed after the `sections` table. On the other hand, when we execute the full restore including schema and data, the TOC file is not executed (we'll look inside the `.tar` file at the end of this lesson).

However, another option is to generate a separate `tar` file just to backup the tables data. Therefore, the next step is to generate a file `uniy_db_data_backup.tar` to backup all the tables records.

```console
(base) ludo /pgbackup  $  pg_dump -U usertest -F t -O -a --column-inserts uniy > /Users/ludovicopinzar/pgbackup/uniy_db_data_backup.tar
```

Now, we run the `pg_restore` command again.

```console
(base) ludo /pgbackup  $  pg_restore -U usertest -v -O -a -e -d uniy /Users/ludovicopinzari/Documents/Udacity/Sql_udacity/pgbackup/uniy_db_data_backup.tar
pg_restore: connecting to database for restore
pg_restore: processing data for table "public.courses"
pg_restore: processing data for table "public.teachers"
pg_restore: processing data for table "public.sections"
pg_restore: processing data for table "public.students"
pg_restore: processing data for table "public.enrolls"
```

Finally, we restored the `uniy` sample database.

### Note: uniy database only data

In the last example, we illustrated how to restore the tables records using the `pg_restore` command on a separate backup file `uniy_db_data_backup.tar`. Now, it seems natural to create a separate file for the schema named `uniy_db_schema_backup.tar`. In this way, we could save memory on the disk and separate logically the files of the database.

```console
(base) ludo /pgbackup  $  pg_dump -U usertest -F t -O --no-tablespaces -c --if-exists -s uniy > /Users/ludovicopinzari/pgbackup/uniy_db_schema_backup.tar
```

Now, we have two backup files to restore the `schema` and `data` of the `uniy` sample database.

1. restore the `uniy` **schema**, `uniy_db_schema_backup.tar`:

```console
(base) ludo /pgbackup  $  pg_restore -U usertest -v -O -c --if-exists -s -e -d uniy /Users/ludovicopinzari/pgbackup/uniy_db_schema_backup.tar
pg_restore: connecting to database for restore
pg_restore: dropping FK CONSTRAINT sections sections_fkey_teacher
pg_restore: dropping FK CONSTRAINT sections sections_fkey_course
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_student
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_section
pg_restore: dropping FK CONSTRAINT enrolls enrolls_fkey_course
pg_restore: dropping CONSTRAINT teachers teachers_pkey
pg_restore: dropping CONSTRAINT students students_pkey
pg_restore: dropping CONSTRAINT sections sections_pkey
pg_restore: dropping CONSTRAINT enrolls enrolls_pkey
pg_restore: dropping CONSTRAINT courses courses_pkey
pg_restore: dropping TABLE teachers
pg_restore: dropping TABLE students
pg_restore: dropping TABLE sections
pg_restore: dropping TABLE enrolls
pg_restore: dropping TABLE courses
pg_restore: creating TABLE "public.courses"
pg_restore: creating TABLE "public.enrolls"
pg_restore: creating TABLE "public.sections"
pg_restore: creating TABLE "public.students"
pg_restore: creating TABLE "public.teachers"
pg_restore: creating CONSTRAINT "public.courses courses_pkey"
pg_restore: creating CONSTRAINT "public.enrolls enrolls_pkey"
pg_restore: creating CONSTRAINT "public.sections sections_pkey"
pg_restore: creating CONSTRAINT "public.students students_pkey"
pg_restore: creating CONSTRAINT "public.teachers teachers_pkey"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_course"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_section"
pg_restore: creating FK CONSTRAINT "public.enrolls enrolls_fkey_student"
pg_restore: creating FK CONSTRAINT "public.sections sections_fkey_course"
pg_restore: creating FK CONSTRAINT "public.sections sections_fkey_teacher"
```

2. restore the `uniy` **data**, `uniy_db_data_backup.tar`:

```console
(base) ludo /pgbackup  $  pg_restore -U usertest -v -O -a -e -d uniy /Users/ludovicopinzari/pgbackup/uniy_db_data_backup.tar
pg_restore: connecting to database for restore
pg_restore: processing data for table "public.courses"
pg_restore: processing data for table "public.teachers"
pg_restore: processing data for table "public.sections"
pg_restore: processing data for table "public.students"
pg_restore: processing data for table "public.enrolls"
```

### uny_db_schema_backup.tar internals

If you decompress the `uniy_db_schema_backup.tar` file into the folder `uniy_db_schema_backup`:

```console
(base) ludo /uniy_db_schema_backup  $  ls
restore.sql toc.dat
```

You see there are two files `restore.sql` and `toc.dat`.

You can look inside this file but basically the content is similar to the file `uniy_db_schema_backup.sql` generated by the `pg_dump` command. It's worth noting that this file is not edited like the one we created in the previous lessons.
